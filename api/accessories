#! /usr/bin/env nix-shell
#! nix-shell --pure --keep LOGGING_LEVEL --keep PROFILING -i dash -I channel:nixos-23.05-small -p dash nix jq yq yajsv parallel findutils ncurses
. ./logging
. ./profiling
set -eu

. ./config/caching

logger_info 'Invoked: api/accessories'
logger_trace 'api/accessories'

if [ -n "${HOMEKIT_SH_CACHE_ACCESSORIES:-}" ] && [ -e "$CACHE_DIR"/accessories.json ]; then
    dash ./util/respond.sh 200 "$(cat "$CACHE_DIR"/accessories.json)"
    logger_debug "Accessories retrived from cache"
    exit 0
fi

. ./util/cache_toml.sh

accessories="$(find ./accessories -name '*.toml' |\
               parallel --jobs 0${PROFILING:+1} "aid=\$(dash ./util/aid.sh {}); dash ./util/services_grouped_by_type.sh {} | parallel --jobs 0${PROFILING:+1} dash ./util/generate_service.sh 1 \$aid | jq -cs \"{ aid: \$aid, services: map({type, iid, characteristics}) }\"" |\
               jq -cs '{accessories: map(.services |= map(del(.cmd, .polling) | .characteristics |= map(del(.cmd, .polling))))}')"

if [ -n "${HOMEKIT_SH_CACHE_ACCESSORIES:-}" ]; then
    test -e "$CACHE_DIR" || mkdir -p "$CACHE_DIR"
    echo "$accessories" > "$CACHE_DIR"/accessories.json
fi

dash ./util/respond.sh 200 "$accessories"
