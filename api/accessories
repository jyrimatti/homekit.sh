#! /usr/bin/env nix-shell
#! nix-shell -i dash -I channel:nixos-23.11-small -p dash nix jq yq yajsv findutils ncurses sqlite
. ./prelude
set -eu

logger_info 'Invoked: api/accessories'
logger_trace 'api/accessories'

tomls="$(find "$HOMEKIT_SH_ACCESSORIES_DIR" -maxdepth 3 -name '*.toml')"

if [ "${HOMEKIT_SH_CACHE_ACCESSORIES:-false}" = "true" ] && [ -e "$HOMEKIT_SH_CACHE_DIR"/accessories.json ]; then
    while read -r toml; do
        if [ "$HOMEKIT_SH_CACHE_DIR"/accessories.json -ot "$toml" ]; then
            # cached exists and is older than this toml -> don't use cache
            exit 1
        fi
    done && {
        dash ./util/respond.sh 200 "$(cat "$HOMEKIT_SH_CACHE_DIR"/accessories.json)"
        logger_debug "Accessories retrived from cache"
        exit 0
    }
fi

. ./util/cache_toml.sh

accessories="$(echo "$tomls" \
    | ./bin/rust-parallel-"$(uname)" --shell-path dash --jobs "${PROFILING:-$(echo "$tomls" | wc -l)}" -s dash ./util/accessory.sh \
    | jq -cs '{ accessories: map(.services |= map(del(.cmd, .polling, .typeName) | .characteristics |= map(del(.cmd, .polling, .typeName, .ev)))) }')"

if [ "${HOMEKIT_SH_CACHE_ACCESSORIES:-false}" = "true" ]; then
    echo "$accessories" > "$HOMEKIT_SH_CACHE_DIR"/accessories.json
fi

dash ./util/respond.sh 200 "$accessories"
