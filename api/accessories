#! /usr/bin/env nix-shell
#! nix-shell -i dash -I channel:nixos-23.11-small -p dash nix jq yq yajsv findutils ncurses sqlite
. ./prelude
set -eu

logger_info 'Invoked: api/accessories'
logger_trace 'api/accessories'

tomls="$(find "$HOMEKIT_SH_ACCESSORIES_DIR" -maxdepth 3 -name '*.toml')"

. ./util/cache_toml.sh

accessories="$(echo "$tomls" \
    | xargs -n1 dash ./util/accessory.sh \
    | jq -cs '{ accessories: map(.services |= map(del(.cmd, .polling, .typeName) | .characteristics |= map(del(.cmd, .polling, .typeName, .ev)))) }')"

dash ./util/respond.sh 200 "$accessories"
