#! /usr/bin/env nix-shell
#! nix-shell --keep LOGGING_LEVEL --keep PROFILING -i dash -I channel:nixos-23.05-small -p dash nodejs ncurses
. ./logging
. ./profiling
set -eu

logger_info 'Invoked api/pair-verify'
logger_trace 'api/pair-verify'

tmpfile="$(mktemp /tmp/homekit.sh_pair-verify.XXXXXX)"

(cd pairing && SESSION_STORE_PATH="sessions/$REMOTE_ADDR:$REMOTE_PORT" npm run pairVerify --silent > "$tmpfile")

date -u +%Y-%m-%dT%H:%M:%SZ > "./store/sessions/$REMOTE_ADDR:$REMOTE_PORT/verified"
date +%Y-%m-%dT%H:%M:%S >> "./store/sessions/$REMOTE_ADDR:$REMOTE_PORT/verified"

cat "$tmpfile"