#! /usr/bin/env nix-shell
#! nix-shell --keep LOGGING_LEVEL --keep PROFILING -i dash -I channel:nixos-23.05-small -p dash nodejs
. ./logging
. ./profiling
set -u

logger_info 'Invoked api/pair-setup'
logger_trace 'api/pair-setup'

tmpfile=$(mktemp /tmp/homekit.sh_pair-setup.XXXXXX)

(cd pairing && SESSION_STORE_PATH="sessions/$REMOTE_ADDR:$REMOTE_PORT" npm run pairSetup --silent > "$tmpfile")

if [ $? -eq 42 ]; then
    logger_info 'Removing flag and changing configuration number in dns-txt'
    sed -i 's/sf=1//' store/dns-txt
    sed -i 's/c#=1/c#=2/' store/dns-txt
    logger_debug 'Waiting 3 seconds to let the dns-txt change propagate'
    sleep 3
fi

logger_info 'Pair setup finished!'
cat "$tmpfile"
