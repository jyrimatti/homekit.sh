#! /usr/bin/env nix-shell
#! nix-shell --pure --keep LOGGING_LEVEL --keep PROFILING --keep REQUEST_METHOD --keep QUERY_STRING --keep REMOTE_ADDR --keep REMOTE_PORT -i dash -I channel:nixos-23.05-small -p dash nix jq yq parallel findutils ncurses
. ./logging
. ./profiling
set -eu

logger_info 'Invoked api/characteristics'
logger_trace 'api/characteristics'

. ./util/cache_toml.sh

if [ "$REQUEST_METHOD" = "GET" ]; then
    logger_debug 'Request is a GET'
    . ./util/cgi_helpers.sh

    meta="${qs_meta_:-0}"
    perms="${qs_perms:-0}"
    type="${qs_type:-0}"
    ev="${qs_ev:-0}"

    characteristics=$(echo "${qs_id}" |\
                      tr ',' '\n' |\
                      parallel --jobs 0${PROFILING:+1} ./util/characteristics_get.sh "$meta" "$perms" "$type" "$ev")
fi

if [ "$REQUEST_METHOD" = 'PUT' ]; then
    logger_debug 'Request is a PUT'
    characteristics=$(cat |\
                      jq -rc '.characteristics | .[] | [.aid, .iid, .value, .ev, .authData, .remote // false, .r // false] | @sh' |\
                      parallel --jobs 0${PROFILING:+1} ./util/characteristics_put.sh '{= uq =}')
fi

has_errors=$(echo "$characteristics" | jq -r 'select(.status // 0 != 0) | .status')
if [ "$has_errors" != "" ]; then
    logger_debug 'There were errors'
    content=$(echo "$characteristics" | jq -s '{ characteristics: map(.status = (.status // 0)) }')
    ./util/respond.sh 207 "$content"
elif [ "$REQUEST_METHOD" = 'GET' ]; then
    content=$(echo "$characteristics" | jq -s '{ characteristics: . }')
    ./util/respond.sh 200 "$content"
elif [ "$REQUEST_METHOD" = 'PUT' ]; then
    ./util/respond.sh 204
fi
